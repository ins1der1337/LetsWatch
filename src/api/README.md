# LetsWatch - Backend

## Как запустить API?

### **КРАТКО**

1. Установить зависимости - `pip install -r requirements.txt`
2. Апргейднуться до последней миграции БД - `alembic upgrade head`
3. `main.py`

### 1.1. С помощью `uv` (_рекомендуется_)

1. Необходимо скачать пакетный менеджер **uv** 

    ```shell
    pip install uv
    ```

2. Создаем виртуальное окружение и устанавливаем зависимости
    
    ```shell
    uv venv
    .venv/Scripts/activate
    uv sync
    ```

Подробнее ознакомиться с командами **uv** можно по [ссылке](https://habr.com/ru/articles/875840/)

### 1.2. С помощью обычного пакетного менеджера `pip`

1. Создаем виртуальное окружение и устанавливаем зависимости

   ```shell
   python -m venv .venv
   .venv/Scripts/activate
   pip install -r requirements.txt
   ```

Указываем нужный интерпретатор и запускаем `main.py`

> В дальнейшем возможно запуск будет совершаться через `docker-compose.yml` 

## Настройки конфигурации

Для работы с переменными окружения (`.env`) используется библиотека `pydantic-settings`.
Она позволяет группировать и валидировать данные настройки (например `AppDBConfig` отвечает конкретно за БД
и валидирует url из Postgres)

При инициализации полей `(bot, db)` pydantic автоматически создаёт экземпляры этих классов, используя
вложенные переменные окружения с разделителем `__`. Например, для `tmdb_api: TMDPApiConfig` будут прочитаны
переменные вида `TMDB_API__KEY=value`, используя разделитель `__`

Приоритет загрузки: `.env` → `.env.example` → значения по умолчанию (если есть), без учёта регистра (case_sensitive=False).

### Как использовать ?

```shell
# config.py
settings = Settings()

# Другой модуль...
print(settings.db.url)    # Доступ к настройкам БД
print(settings.api.port)  # Доступ к настройкам API
```

## Миграции Alembic

Запуск команд происходит из папки `src`

### Создание миграций

```shell
alembic revision --autogenerate -m "название миграции"
```

После создания миграции, важно проверить правильно ли работает `upgrade()` и `downgrade()`

### Применение и откат миграций

```shell
alembic upgrade head     # Накатит последнюю миграцию
alembic downgrade base   # Откатиться до первой миграции (дроп таблиц)

alembic upgrade <хэш>    # "Апгрейд" до конкретной миграции
alembic downgrade <хэш>  # Откатиться до конкретной миграции
```
